<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NÃ¶bet Ã‡izelgesi Sistemi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --army-green: #4a5d3e;
            --dark-green: #3a4d2e;
            --cream: #d4c5a9;
            --dark-cream: #b8a989;
            --black: #1a1a1a;
            --light-bg: #f4f0e6;
            --border-color: #8b8166;
            --error-red: #8b2e2e;
            --success-green: #2e5d2e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--light-bg) 0%, var(--cream) 100%);
            color: var(--black);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, var(--dark-green) 0%, var(--army-green) 100%);
            color: var(--cream);
            padding: 25px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 2px solid var(--dark-green);
        }

        header h1 {
            font-size: 2rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--army-green);
            padding-bottom: 10px;
        }

        .tab-button {
            background: var(--cream);
            color: var(--black);
            border: 2px solid var(--border-color);
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .tab-button:hover {
            background: var(--dark-cream);
        }

        .tab-button.active {
            background: var(--army-green);
            color: var(--cream);
            border-bottom: 2px solid var(--army-green);
        }

        .tab-content {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 2px solid var(--border-color);
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--light-bg);
            border-radius: 6px;
            border-left: 4px solid var(--army-green);
        }

        .section h2 {
            color: var(--dark-green);
            margin-bottom: 15px;
            font-size: 1.3rem;
            text-transform: uppercase;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-green);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            margin-bottom: 15px;
            background: white;
        }

        input[type="file"] {
            margin-bottom: 15px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: white;
        }

        textarea {
            min-height: 120px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        button {
            background: var(--army-green);
            color: var(--cream);
            border: 2px solid var(--dark-green);
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            background: var(--dark-green);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: var(--dark-cream);
            color: var(--black);
            border-color: var(--border-color);
        }

        button.secondary:hover {
            background: var(--border-color);
        }

        button.danger {
            background: var(--error-red);
            border-color: #6b1e1e;
        }

        button.danger:hover {
            background: #6b1e1e;
        }

        .hint {
            background: #fff9e6;
            border-left: 4px solid #f4c542;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #856404;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
        }

        th {
            background: var(--army-green);
            color: var(--cream);
            padding: 8px 4px;
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            border: 1px solid var(--dark-green);
            white-space: nowrap;
        }

        td {
            padding: 10px 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        tr:nth-child(even) {
            background: var(--light-bg);
        }

        tr:hover {
            background: var(--cream);
        }
        
        /* Sticky column for personnel names */
        td:first-child, th:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
        }
        
        thead th:first-child {
            z-index: 11;
        }

        .personnel-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            background: white;
        }

        .personnel-item {
            background: var(--light-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid var(--army-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .personnel-info {
            flex: 1;
        }

        .personnel-name {
            font-weight: 700;
            color: var(--dark-green);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .personnel-constraints {
            font-size: 0.85rem;
            color: #555;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 3px solid var(--army-green);
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h3 {
            color: var(--dark-green);
            text-transform: uppercase;
        }

        .close-modal {
            background: var(--error-red);
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 600;
        }

        .close-modal:hover {
            background: #6b1e1e;
        }

        .date-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .date-tag {
            background: var(--army-green);
            color: var(--cream);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-tag button {
            background: transparent;
            border: none;
            color: var(--cream);
            cursor: pointer;
            padding: 0;
            font-size: 1.2rem;
            line-height: 1;
        }

        .weekend {
            background: #fff3cd;
        }

        .locked {
            background: #d1ecf1;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--army-green);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
            text-transform: uppercase;
        }

        .rule-config {
            padding-left: 30px;
        }

        .rule-config.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .error-message {
            background: #f8d7da;
            color: var(--error-red);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--error-red);
        }

        .success-message {
            background: #d4edda;
            color: var(--success-green);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success-green);
        }

        .swap-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header h1 {
                font-size: 1.5rem;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-button {
                width: 100%;
            }

            .swap-controls {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>NÃ¶bet Ã‡izelgesi YÃ¶netim Sistemi</h1>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('personnel')">Personel YÃ¶netimi</button>
            <button class="tab-button" onclick="switchTab('rules')">Kural AyarlarÄ±</button>
            <button class="tab-button" onclick="switchTab('generate')">Ã‡izelge OluÅŸtur</button>
            <button class="tab-button" onclick="switchTab('schedule')">NÃ¶bet Ã‡izelgesi</button>
            <button class="tab-button" onclick="switchTab('swap')">NÃ¶bet DeÄŸiÅŸimi</button>
        </div>

        <!-- Personnel Management Tab -->
        <div id="personnel-tab" class="tab-content active">
            <div class="section">
                <h2>Personel Ekleme</h2>
                
                <div class="hint">
                    ğŸ’¡ TXT dosyasÄ±nda her satÄ±r: <strong>Ä°sim,NÃ¶betSayÄ±sÄ±,Ä°stisnaGÃ¼nler</strong> formatÄ±nda olmalÄ±dÄ±r.<br>
                    <strong>Format:</strong> <code>"Ä°sim","AylÄ±k NÃ¶bet SayÄ±sÄ±","(Ä°stisna GÃ¼nler - sadece gÃ¼n numarasÄ±)"</code><br>
                    <strong>Ã–rnekler:</strong><br>
                    <code>Ahmet YÄ±lmaz,3,(5,15,20)</code> - AyÄ±n 5, 15 ve 20'sinde nÃ¶bet tutamaz<br>
                    <code>Mehmet Demir,5,()</code> - Ä°stisna yok<br>
                    <code>AyÅŸe Kaya,4,(10)</code> - Sadece ayÄ±n 10'unda nÃ¶bet tutamaz
                </div>

                <label for="txt-file">TXT DosyasÄ±ndan Ä°Ã§e Aktar:</label>
                <input type="file" id="txt-file" accept=".txt">
                <button onclick="importFromFile()">Dosyadan YÃ¼kle</button>

                <div style="margin: 20px 0; text-align: center; color: var(--border-color); font-weight: 600;">
                    - VEYA -
                </div>

                <label for="manual-input">Manuel GiriÅŸ (Her satÄ±ra: Ä°sim,NÃ¶betSayÄ±sÄ±,Ä°stisnaGÃ¼nler):</label>
                <textarea id="manual-input" placeholder="Ahmet YÄ±lmaz,3,(5,15,20)&#10;Mehmet Demir,5,()&#10;AyÅŸe Kaya,4,(10)"></textarea>
                <button onclick="addPersonnelManually()">Manuel Ekle</button>
            </div>

            <div class="section">
                <h2>Personel Listesi</h2>
                <div id="personnel-list" class="personnel-list">
                    <p style="text-align: center; color: #999;">HenÃ¼z personel eklenmedi.</p>
                </div>
            </div>
        </div>

        <!-- Rules Configuration Tab -->
        <div id="rules-tab" class="tab-content">
            <div class="section">
                <h2>âš™ï¸ NÃ¶bet KurallarÄ± YapÄ±landÄ±rmasÄ±</h2>
                
                <div class="hint">
                    â„¹ï¸ Bu kurallar Ã§izelge oluÅŸturulurken otomatik olarak uygulanÄ±r. Ä°htiyacÄ±nÄ±za gÃ¶re Ã¶zelleÅŸtirebilirsiniz.
                </div>

                <div style="background: white; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="color: var(--dark-green); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="rule-max-per-week" checked onchange="updateRuleStatus()">
                        <label for="rule-max-per-week" style="cursor: pointer; margin: 0;">HaftalÄ±k NÃ¶bet SÄ±nÄ±rÄ±</label>
                    </h3>
                    <div id="rule-max-per-week-config" class="rule-config">
                        <label for="max-duties-per-week">KiÅŸi baÅŸÄ± maksimum nÃ¶bet sayÄ±sÄ± (haftalÄ±k):</label>
                        <input type="number" id="max-duties-per-week" min="1" max="7" value="1">
                        <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                            ğŸ“Œ Her kiÅŸi bir haftada en fazla bu kadar nÃ¶bet tutabilir.
                        </p>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="color: var(--dark-green); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="rule-min-gap" checked onchange="updateRuleStatus()">
                        <label for="rule-min-gap" style="cursor: pointer; margin: 0;">Minimum GÃ¼n AralÄ±ÄŸÄ±</label>
                    </h3>
                    <div id="rule-min-gap-config" class="rule-config">
                        <label for="min-days-gap">AynÄ± kiÅŸinin nÃ¶betleri arasÄ±nda minimum gÃ¼n sayÄ±sÄ±:</label>
                        <input type="number" id="min-days-gap" min="0" max="14" value="3">
                        <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                            ğŸ“Œ Bir kiÅŸinin iki nÃ¶beti arasÄ±nda en az bu kadar gÃ¼n olmalÄ±dÄ±r.
                        </p>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="color: var(--dark-green); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="rule-no-consecutive" checked onchange="updateRuleStatus()">
                        <label for="rule-no-consecutive" style="cursor: pointer; margin: 0;">ArdÄ±ÅŸÄ±k GÃ¼n YasaÄŸÄ±</label>
                    </h3>
                    <div id="rule-no-consecutive-config" class="rule-config">
                        <p style="font-size: 0.9rem; color: #666;">
                            ğŸ“Œ AynÄ± kiÅŸi arka arkaya iki gÃ¼n nÃ¶bet tutamaz (Ã¶rn. Pazartesi ve SalÄ±).
                        </p>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="color: var(--dark-green); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="rule-weekend-balance" checked onchange="updateRuleStatus()">
                        <label for="rule-weekend-balance" style="cursor: pointer; margin: 0;">Hafta Sonu/Ä°Ã§i Dengesi</label>
                    </h3>
                    <div id="rule-weekend-balance-config" class="rule-config">
                        <label for="weekend-balance-mode">Denge Modu:</label>
                        <select id="weekend-balance-mode">
                            <option value="strict">SÄ±kÄ±: Hafta iÃ§i â‰¥ Hafta sonu (asla daha az olamaz)</option>
                            <option value="prefer">Tercih: Hafta iÃ§i nÃ¶betler Ã¶ncelikli</option>
                            <option value="none">Yok: Hafta sonu/iÃ§i dengesi kontrol edilmez</option>
                        </select>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                            ğŸ“Œ KiÅŸi baÅŸÄ±na hafta sonu ve hafta iÃ§i nÃ¶bet daÄŸÄ±lÄ±mÄ± dengelenir.
                        </p>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="color: var(--dark-green); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="rule-fair-distribution" checked onchange="updateRuleStatus()">
                        <label for="rule-fair-distribution" style="cursor: pointer; margin: 0;">Adil DaÄŸÄ±lÄ±m</label>
                    </h3>
                    <div id="rule-fair-distribution-config" class="rule-config">
                        <label for="distribution-mode">DaÄŸÄ±lÄ±m Stratejisi:</label>
                        <select id="distribution-mode">
                            <option value="balanced">Dengeli: Herkes eÅŸit nÃ¶bet tutar</option>
                            <option value="priority">Ã–ncelikli: Az nÃ¶bet tutanlar Ã¶nce atanÄ±r</option>
                            <option value="random">Rastgele: Uygun kiÅŸilerden rastgele seÃ§ilir</option>
                        </select>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                            ğŸ“Œ NÃ¶betler nasÄ±l daÄŸÄ±tÄ±lsÄ±n?
                        </p>
                    </div>
                </div>

                <div class="btn-group">
                    <button onclick="saveRules()">ğŸ’¾ KurallarÄ± Kaydet</button>
                    <button class="secondary" onclick="resetRulesToDefault()">ğŸ”„ VarsayÄ±lana DÃ¶n</button>
                    <button class="secondary" onclick="loadPreset('relaxed')">ğŸ˜Œ Esnek Kurallar</button>
                    <button class="secondary" onclick="loadPreset('strict')">ğŸ¯ KatÄ± Kurallar</button>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ“Š Aktif Kurallar Ã–zeti</h2>
                <div id="rules-summary" style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid var(--army-green);">
                </div>
            </div>
        </div>

        <!-- Generate Schedule Tab -->
        <div id="generate-tab" class="tab-content">
            <div class="section">
                <h2>Ã‡izelge Parametreleri</h2>
                
                <div class="hint">
                    ğŸ“… <strong>Ã–nemli:</strong> SeÃ§tiÄŸiniz ayÄ±n <strong>1. gÃ¼nÃ¼nden son gÃ¼nÃ¼ne kadar</strong> otomatik olarak Ã§izelge oluÅŸturulur.<br>
                    Ã–rnek: Åubat 2026 seÃ§erseniz â†’ 1 Åubat'tan 28 Åubat'a kadar tÃ¼m gÃ¼nler dahil edilir.
                </div>
                
                <label for="schedule-month">Ay ve YÄ±l SeÃ§in:</label>
                <input type="month" id="schedule-month" required>

                <button onclick="generateSchedule()" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                    ğŸ—“ï¸ Ã‡izelge OluÅŸtur
                </button>

                <div id="generation-message"></div>
            </div>

            <div class="section">
                <h2>Ã‡izelge Ä°statistikleri</h2>
                <div id="schedule-stats" class="stats-grid">
                    <p style="text-align: center; color: #999;">HenÃ¼z Ã§izelge oluÅŸturulmadÄ±.</p>
                </div>
            </div>
        </div>

        <!-- Schedule View Tab -->
        <div id="schedule-tab" class="tab-content">
            <div class="section">
                <h2>AylÄ±k NÃ¶bet Ã‡izelgesi</h2>
                
                <div class="btn-group">
                    <button onclick="exportToExcel()">ğŸ“Š Excel Olarak DÄ±ÅŸa Aktar</button>
                    <button onclick="exportToPDF()">ğŸ“„ PDF Olarak DÄ±ÅŸa Aktar</button>
                    <button class="secondary" onclick="exportToCSV()">ğŸ’¾ HTML/CSV DÄ±ÅŸa Aktar</button>
                    <button class="secondary" onclick="printSchedule()">ğŸ–¨ï¸ YazdÄ±r</button>
                </div>

                <div id="schedule-table-container">
                    <p style="text-align: center; color: #999; padding: 40px;">HenÃ¼z Ã§izelge oluÅŸturulmadÄ±.</p>
                </div>
            </div>
        </div>

        <!-- Swap Tab -->
        <div id="swap-tab" class="tab-content">
            <div class="section">
                <h2>NÃ¶bet DeÄŸiÅŸimi</h2>
                
                <div class="hint">
                    â„¹ï¸ Ä°ki nÃ¶bet gÃ¼nÃ¼nÃ¼ seÃ§erek personel deÄŸiÅŸimi yapabilirsiniz.
                </div>

                <div class="swap-controls">
                    <div>
                        <label for="swap-date-1">1. NÃ¶bet GÃ¼nÃ¼:</label>
                        <select id="swap-date-1">
                            <option value="">GÃ¼n SeÃ§in</option>
                        </select>
                    </div>
                    <div>
                        <label for="swap-date-2">2. NÃ¶bet GÃ¼nÃ¼:</label>
                        <select id="swap-date-2">
                            <option value="">GÃ¼n SeÃ§in</option>
                        </select>
                    </div>
                </div>

                <button onclick="performSwap()" style="width: 100%;">ğŸ”„ NÃ¶betleri DeÄŸiÅŸtir</button>

                <div id="swap-message"></div>

                <div style="margin-top: 30px;">
                    <h3 style="color: var(--dark-green); margin-bottom: 15px;">GÃ¼ncel Ã‡izelge Ã–nizleme</h3>
                    <div id="swap-preview">
                        <p style="text-align: center; color: #999;">HenÃ¼z Ã§izelge oluÅŸturulmadÄ±.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Personnel Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Personel DÃ¼zenle</h3>
                <button class="close-modal" onclick="closeEditModal()">âœ•</button>
            </div>

            <input type="hidden" id="edit-person-index">

            <label>Ä°sim:</label>
            <input type="text" id="edit-person-name" disabled>

            <label for="edit-max-duties">Maksimum AylÄ±k NÃ¶bet SayÄ±sÄ±:</label>
            <input type="number" id="edit-max-duties" min="0" value="10">

            <label for="edit-exception-date">MÃ¼sait OlmadÄ±ÄŸÄ± Tarihler:</label>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="date" id="edit-exception-date" style="flex: 1;">
                <button onclick="addExceptionDate()">Ekle</button>
            </div>
            <div id="exception-dates-list" class="date-list"></div>

            <label for="edit-fixed-date">Manuel Sabit NÃ¶bet Tarihleri:</label>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="date" id="edit-fixed-date" style="flex: 1;">
                <button onclick="addFixedDate()">Ekle</button>
            </div>
            <div id="fixed-dates-list" class="date-list"></div>

            <div class="btn-group">
                <button onclick="savePersonnelEdit()">ğŸ’¾ Kaydet</button>
                <button class="secondary" onclick="closeEditModal()">Ä°ptal</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let personnel = [];
        let schedule = [];
        let currentEditIndex = -1;
        
        // Rules configuration
        let rulesConfig = {
            maxDutiesPerWeek: {
                enabled: true,
                value: 1
            },
            minDaysGap: {
                enabled: true,
                value: 3
            },
            noConsecutive: {
                enabled: true
            },
            weekendBalance: {
                enabled: true,
                mode: 'strict' // 'strict', 'prefer', 'none'
            },
            fairDistribution: {
                enabled: true,
                mode: 'balanced' // 'balanced', 'priority', 'random'
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default month to current month
            const now = new Date();
            const monthInput = document.getElementById('schedule-month');
            monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            // Initialize rules summary
            updateRulesSummary();
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');

            if (tabName === 'swap' || tabName === 'schedule') {
                updateSwapSelects();
                updateSwapPreview();
            }
        }

        // Import from file
        function importFromFile() {
            const fileInput = document.getElementById('txt-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('LÃ¼tfen bir dosya seÃ§in.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                let addedCount = 0;
                let errors = [];
                
                lines.forEach((line, index) => {
                    // Parse format: Name,DutyCount,(ExceptionDays)
                    // Example: Ahmet YÄ±lmaz,3,(5,15,20)
                    
                    // Remove quotes if present
                    line = line.replace(/"/g, '');
                    
                    // Split by comma, but preserve days inside parentheses
                    const match = line.match(/^([^,]+),(\d+),\(([^)]*)\)$/);
                    
                    if (!match) {
                        errors.push(`SatÄ±r ${index + 1}: GeÃ§ersiz format. Beklenen: Ä°sim,NÃ¶betSayÄ±sÄ±,(GÃ¼nler)`);
                        return;
                    }
                    
                    const name = match[1].trim();
                    const dutyCount = parseInt(match[2].trim());
                    const exceptionDaysStr = match[3].trim();
                    
                    if (!name || name.length === 0) {
                        errors.push(`SatÄ±r ${index + 1}: Ä°sim boÅŸ olamaz`);
                        return;
                    }
                    
                    if (isNaN(dutyCount) || dutyCount < 0) {
                        errors.push(`SatÄ±r ${index + 1}: GeÃ§ersiz nÃ¶bet sayÄ±sÄ± (${match[2]})`);
                        return;
                    }
                    
                    // Parse exception days (just day numbers)
                    let exceptionDays = [];
                    if (exceptionDaysStr.length > 0) {
                        exceptionDays = exceptionDaysStr.split(',')
                            .map(d => d.trim())
                            .filter(d => d.length > 0);
                        
                        // Validate day numbers
                        for (const day of exceptionDays) {
                            const dayNum = parseInt(day);
                            if (isNaN(dayNum) || dayNum < 1 || dayNum > 31) {
                                errors.push(`SatÄ±r ${index + 1}: GeÃ§ersiz gÃ¼n numarasÄ±: ${day}. 1-31 arasÄ± olmalÄ±.`);
                                return;
                            }
                        }
                    }
                    
                    // Add or update person
                    const existingPerson = personnel.find(p => p.name === name);
                    if (!existingPerson) {
                        personnel.push({
                            name: name,
                            maxDutiesPerMonth: dutyCount,
                            exceptionDates: [], // Will be converted to full dates when schedule is generated
                            exceptionDays: exceptionDays.map(d => parseInt(d)), // Store day numbers
                            fixedDates: []
                        });
                        addedCount++;
                    } else {
                        // Update existing person
                        existingPerson.maxDutiesPerMonth = dutyCount;
                        existingPerson.exceptionDays = exceptionDays.map(d => parseInt(d));
                        existingPerson.exceptionDates = []; // Reset full dates
                        addedCount++;
                    }
                });
                
                updatePersonnelList();
                
                if (errors.length > 0) {
                    alert(`${addedCount} personel eklendi/gÃ¼ncellendi.\n\nHatalar:\n${errors.join('\n')}`);
                } else {
                    alert(`${addedCount} personel baÅŸarÄ±yla eklendi/gÃ¼ncellendi.`);
                }
                
                fileInput.value = '';
            };
            
            reader.readAsText(file);
        }

        // Add personnel manually
        function addPersonnelManually() {
            const input = document.getElementById('manual-input');
            const lines = input.value.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            if (lines.length === 0) {
                alert('LÃ¼tfen en az bir satÄ±r girin.');
                return;
            }

            let addedCount = 0;
            let errors = [];
            
            lines.forEach((line, index) => {
                // Remove quotes if present
                line = line.replace(/"/g, '');
                
                // Parse format: Name,DutyCount,(ExceptionDays)
                const match = line.match(/^([^,]+),(\d+),\(([^)]*)\)$/);
                
                if (!match) {
                    errors.push(`SatÄ±r ${index + 1}: GeÃ§ersiz format. Beklenen: Ä°sim,NÃ¶betSayÄ±sÄ±,(GÃ¼nler)`);
                    return;
                }
                
                const name = match[1].trim();
                const dutyCount = parseInt(match[2].trim());
                const exceptionDaysStr = match[3].trim();
                
                if (!name || name.length === 0) {
                    errors.push(`SatÄ±r ${index + 1}: Ä°sim boÅŸ olamaz`);
                    return;
                }
                
                if (isNaN(dutyCount) || dutyCount < 0) {
                    errors.push(`SatÄ±r ${index + 1}: GeÃ§ersiz nÃ¶bet sayÄ±sÄ± (${match[2]})`);
                    return;
                }
                
                // Parse exception days (just day numbers)
                let exceptionDays = [];
                if (exceptionDaysStr.length > 0) {
                    exceptionDays = exceptionDaysStr.split(',')
                        .map(d => d.trim())
                        .filter(d => d.length > 0);
                    
                    // Validate day numbers
                    for (const day of exceptionDays) {
                        const dayNum = parseInt(day);
                        if (isNaN(dayNum) || dayNum < 1 || dayNum > 31) {
                            errors.push(`SatÄ±r ${index + 1}: GeÃ§ersiz gÃ¼n numarasÄ±: ${day}. 1-31 arasÄ± olmalÄ±.`);
                            return;
                        }
                    }
                }
                
                // Add or update person
                const existingPerson = personnel.find(p => p.name === name);
                if (!existingPerson) {
                    personnel.push({
                        name: name,
                        maxDutiesPerMonth: dutyCount,
                        exceptionDates: [],
                        exceptionDays: exceptionDays.map(d => parseInt(d)),
                        fixedDates: []
                    });
                    addedCount++;
                } else {
                    // Update existing person
                    existingPerson.maxDutiesPerMonth = dutyCount;
                    existingPerson.exceptionDays = exceptionDays.map(d => parseInt(d));
                    existingPerson.exceptionDates = [];
                    addedCount++;
                }
            });
            
            updatePersonnelList();
            
            if (errors.length > 0) {
                alert(`${addedCount} personel eklendi/gÃ¼ncellendi.\n\nHatalar:\n${errors.join('\n')}`);
            } else {
                alert(`${addedCount} personel baÅŸarÄ±yla eklendi/gÃ¼ncellendi.`);
            }
            
            input.value = '';
        }

        // Update personnel list display
        function updatePersonnelList() {
            const container = document.getElementById('personnel-list');
            
            if (personnel.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">HenÃ¼z personel eklenmedi.</p>';
                return;
            }

            container.innerHTML = personnel.map((person, index) => {
                const exceptionDaysText = person.exceptionDays && person.exceptionDays.length > 0 
                    ? person.exceptionDays.join(', ') 
                    : (person.exceptionDates && person.exceptionDates.length > 0 ? person.exceptionDates.length : '0');
                    
                return `
                <div class="personnel-item">
                    <div class="personnel-info">
                        <div class="personnel-name">${person.name}</div>
                        <div class="personnel-constraints">
                            Max NÃ¶bet: ${person.maxDutiesPerMonth}/ay | 
                            Ä°stisna GÃ¼nler: ${exceptionDaysText} | 
                            Sabit NÃ¶bet: ${person.fixedDates ? person.fixedDates.length : 0}
                        </div>
                    </div>
                    <div>
                        <button onclick="editPersonnel(${index})">âœï¸ DÃ¼zenle</button>
                        <button class="danger" onclick="deletePersonnel(${index})" style="margin-left: 5px;">ğŸ—‘ï¸ Sil</button>
                    </div>
                </div>
            `}).join('');
        }

        // Edit personnel
        function editPersonnel(index) {
            currentEditIndex = index;
            const person = personnel[index];

            document.getElementById('edit-person-index').value = index;
            document.getElementById('edit-person-name').value = person.name;
            document.getElementById('edit-max-duties').value = person.maxDutiesPerMonth;
            
            updateExceptionDatesList();
            updateFixedDatesList();
            
            document.getElementById('edit-modal').classList.add('active');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
            currentEditIndex = -1;
        }

        // Add exception date
        function addExceptionDate() {
            const dateInput = document.getElementById('edit-exception-date');
            const date = dateInput.value;
            
            if (!date) {
                alert('LÃ¼tfen bir tarih seÃ§in.');
                return;
            }

            const person = personnel[currentEditIndex];
            if (!person.exceptionDates.includes(date)) {
                person.exceptionDates.push(date);
                updateExceptionDatesList();
                dateInput.value = '';
            }
        }

        // Update exception dates list
        function updateExceptionDatesList() {
            const container = document.getElementById('exception-dates-list');
            const person = personnel[currentEditIndex];
            
            if (person.exceptionDates.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 0.9rem;">HenÃ¼z istisna tarih eklenmedi.</p>';
                return;
            }

            container.innerHTML = person.exceptionDates.map(date => `
                <div class="date-tag">
                    ${formatDate(date)}
                    <button onclick="removeExceptionDate('${date}')">âœ•</button>
                </div>
            `).join('');
        }

        // Remove exception date
        function removeExceptionDate(date) {
            const person = personnel[currentEditIndex];
            person.exceptionDates = person.exceptionDates.filter(d => d !== date);
            updateExceptionDatesList();
        }

        // Add fixed date
        function addFixedDate() {
            const dateInput = document.getElementById('edit-fixed-date');
            const date = dateInput.value;
            
            if (!date) {
                alert('LÃ¼tfen bir tarih seÃ§in.');
                return;
            }

            const person = personnel[currentEditIndex];
            if (!person.fixedDates.includes(date)) {
                person.fixedDates.push(date);
                updateFixedDatesList();
                dateInput.value = '';
            }
        }

        // Update fixed dates list
        function updateFixedDatesList() {
            const container = document.getElementById('fixed-dates-list');
            const person = personnel[currentEditIndex];
            
            if (person.fixedDates.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 0.9rem;">HenÃ¼z sabit nÃ¶bet tarihi eklenmedi.</p>';
                return;
            }

            container.innerHTML = person.fixedDates.map(date => `
                <div class="date-tag">
                    ${formatDate(date)}
                    <button onclick="removeFixedDate('${date}')">âœ•</button>
                </div>
            `).join('');
        }

        // Remove fixed date
        function removeFixedDate(date) {
            const person = personnel[currentEditIndex];
            person.fixedDates = person.fixedDates.filter(d => d !== date);
            updateFixedDatesList();
        }

        // Save personnel edit
        function savePersonnelEdit() {
            const index = currentEditIndex;
            const maxDuties = parseInt(document.getElementById('edit-max-duties').value);
            
            personnel[index].maxDutiesPerMonth = maxDuties;
            
            updatePersonnelList();
            closeEditModal();
            alert('Personel bilgileri gÃ¼ncellendi.');
        }

        // Delete personnel
        function deletePersonnel(index) {
            if (confirm(`${personnel[index].name} personelini silmek istediÄŸinize emin misiniz?`)) {
                personnel.splice(index, 1);
                updatePersonnelList();
            }
        }

        // Rules Management Functions
        function updateRuleStatus() {
            const rules = [
                { id: 'rule-max-per-week', config: 'rule-max-per-week-config' },
                { id: 'rule-min-gap', config: 'rule-min-gap-config' },
                { id: 'rule-no-consecutive', config: 'rule-no-consecutive-config' },
                { id: 'rule-weekend-balance', config: 'rule-weekend-balance-config' },
                { id: 'rule-fair-distribution', config: 'rule-fair-distribution-config' }
            ];

            rules.forEach(rule => {
                const checkbox = document.getElementById(rule.id);
                const configDiv = document.getElementById(rule.config);
                
                if (checkbox.checked) {
                    configDiv.classList.remove('disabled');
                } else {
                    configDiv.classList.add('disabled');
                }
            });

            updateRulesSummary();
        }

        function saveRules() {
            // Save rule configurations
            rulesConfig.maxDutiesPerWeek.enabled = document.getElementById('rule-max-per-week').checked;
            rulesConfig.maxDutiesPerWeek.value = parseInt(document.getElementById('max-duties-per-week').value);

            rulesConfig.minDaysGap.enabled = document.getElementById('rule-min-gap').checked;
            rulesConfig.minDaysGap.value = parseInt(document.getElementById('min-days-gap').value);

            rulesConfig.noConsecutive.enabled = document.getElementById('rule-no-consecutive').checked;

            rulesConfig.weekendBalance.enabled = document.getElementById('rule-weekend-balance').checked;
            rulesConfig.weekendBalance.mode = document.getElementById('weekend-balance-mode').value;

            rulesConfig.fairDistribution.enabled = document.getElementById('rule-fair-distribution').checked;
            rulesConfig.fairDistribution.mode = document.getElementById('distribution-mode').value;

            updateRulesSummary();
            alert('âœ… Kurallar kaydedildi!');
        }

        function resetRulesToDefault() {
            document.getElementById('rule-max-per-week').checked = true;
            document.getElementById('max-duties-per-week').value = 1;

            document.getElementById('rule-min-gap').checked = true;
            document.getElementById('min-days-gap').value = 3;

            document.getElementById('rule-no-consecutive').checked = true;

            document.getElementById('rule-weekend-balance').checked = true;
            document.getElementById('weekend-balance-mode').value = 'strict';

            document.getElementById('rule-fair-distribution').checked = true;
            document.getElementById('distribution-mode').value = 'balanced';

            updateRuleStatus();
            saveRules();
        }

        function loadPreset(preset) {
            if (preset === 'relaxed') {
                // Relaxed rules - easier to satisfy
                document.getElementById('rule-max-per-week').checked = true;
                document.getElementById('max-duties-per-week').value = 2;

                document.getElementById('rule-min-gap').checked = true;
                document.getElementById('min-days-gap').value = 1;

                document.getElementById('rule-no-consecutive').checked = false;

                document.getElementById('rule-weekend-balance').checked = true;
                document.getElementById('weekend-balance-mode').value = 'prefer';

                document.getElementById('rule-fair-distribution').checked = true;
                document.getElementById('distribution-mode').value = 'priority';

                alert('ğŸ˜Œ Esnek kurallar yÃ¼klendi: HaftalÄ±k 2 nÃ¶bet, 1 gÃ¼n ara, ardÄ±ÅŸÄ±k gÃ¼n izinli, hafta sonu tercihi.');
            } else if (preset === 'strict') {
                // Strict rules - harder to satisfy
                document.getElementById('rule-max-per-week').checked = true;
                document.getElementById('max-duties-per-week').value = 1;

                document.getElementById('rule-min-gap').checked = true;
                document.getElementById('min-days-gap').value = 4;

                document.getElementById('rule-no-consecutive').checked = true;

                document.getElementById('rule-weekend-balance').checked = true;
                document.getElementById('weekend-balance-mode').value = 'strict';

                document.getElementById('rule-fair-distribution').checked = true;
                document.getElementById('distribution-mode').value = 'balanced';

                alert('ğŸ¯ KatÄ± kurallar yÃ¼klendi: HaftalÄ±k 1 nÃ¶bet, 4 gÃ¼n ara, ardÄ±ÅŸÄ±k gÃ¼n yasak, sÄ±kÄ± hafta sonu dengesi.');
            }

            updateRuleStatus();
            saveRules();
        }

        function updateRulesSummary() {
            const summary = document.getElementById('rules-summary');
            if (!summary) return;

            let html = '<ul style="list-style: none; padding: 0; margin: 0;">';

            // Max duties per week
            if (document.getElementById('rule-max-per-week').checked) {
                const value = document.getElementById('max-duties-per-week').value;
                html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœ… <strong>HaftalÄ±k Limit:</strong> KiÅŸi baÅŸÄ± maksimum ${value} nÃ¶bet</li>`;
            } else {
                html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;">âŒ <strong>HaftalÄ±k Limit:</strong> Devre dÄ±ÅŸÄ±</li>`;
            }

            // Min gap
            if (document.getElementById('rule-min-gap').checked) {
                const value = document.getElementById('min-days-gap').value;
                html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœ… <strong>Minimum Ara:</strong> ${value} gÃ¼n</li>`;
            } else {
                html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;">âŒ <strong>Minimum Ara:</strong> Devre dÄ±ÅŸÄ±</li>`;
            }

            // No consecutive
            if (document.getElementById('rule-no-consecutive').checked) {
                html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœ… <strong>ArdÄ±ÅŸÄ±k GÃ¼n:</strong> Yasak</li>`;
            } else {
                html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;">âŒ <strong>ArdÄ±ÅŸÄ±k GÃ¼n:</strong> Ä°zinli</li>`;
            }

            // Weekend balance
            if (document.getElementById('rule-weekend-balance').checked) {
                const mode = document.getElementById('weekend-balance-mode').value;
                const modeText = mode === 'strict' ? 'SÄ±kÄ±' : mode === 'prefer' ? 'Tercih' : 'Yok';
                html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœ… <strong>Hafta Sonu Dengesi:</strong> ${modeText}</li>`;
            } else {
                html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;">âŒ <strong>Hafta Sonu Dengesi:</strong> Devre dÄ±ÅŸÄ±</li>`;
            }

            // Fair distribution
            if (document.getElementById('rule-fair-distribution').checked) {
                const mode = document.getElementById('distribution-mode').value;
                const modeText = mode === 'balanced' ? 'Dengeli' : mode === 'priority' ? 'Ã–ncelikli' : 'Rastgele';
                html += `<li style="padding: 8px 0;">âœ… <strong>DaÄŸÄ±lÄ±m:</strong> ${modeText}</li>`;
            } else {
                html += `<li style="padding: 8px 0;">âŒ <strong>DaÄŸÄ±lÄ±m:</strong> Devre dÄ±ÅŸÄ±</li>`;
            }

            html += '</ul>';
            summary.innerHTML = html;
        }

        // Generate schedule
        function generateSchedule() {
            const messageContainer = document.getElementById('generation-message');
            messageContainer.innerHTML = '';

            if (personnel.length === 0) {
                messageContainer.innerHTML = '<div class="error-message">âŒ LÃ¼tfen Ã¶nce personel ekleyin.</div>';
                return;
            }

            const monthInput = document.getElementById('schedule-month').value;
            if (!monthInput) {
                messageContainer.innerHTML = '<div class="error-message">âŒ LÃ¼tfen bir ay seÃ§in.</div>';
                return;
            }

            // Validate scheduling feasibility
            const validation = validateSchedulingFeasibility(monthInput);
            if (!validation.isValid) {
                messageContainer.innerHTML = `<div class="error-message">âŒ Ã‡izelge OluÅŸturulamÄ±yor!<br><br>${validation.errors.join('<br>')}</div>`;
                return;
            }

            try {
                schedule = createSchedule(monthInput);
                messageContainer.innerHTML = '<div class="success-message">âœ… Ã‡izelge baÅŸarÄ±yla oluÅŸturuldu!</div>';
                displayScheduleStats();
                displayScheduleTable();
                updateSwapSelects();
                
                // Switch to schedule tab
                setTimeout(() => {
                    document.querySelector('[onclick="switchTab(\'schedule\')"]').click();
                }, 1000);
            } catch (error) {
                messageContainer.innerHTML = `<div class="error-message">âŒ Hata: ${error.message}</div>`;
            }
        }

        // Validate if schedule can be created with given constraints
        function validateSchedulingFeasibility(monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            const errors = [];
            
            // Calculate total required duties
            const totalDutiesRequired = daysInMonth;
            
            // Calculate total available duty slots from personnel
            let totalAvailableSlots = 0;
            personnel.forEach(person => {
                totalAvailableSlots += person.maxDutiesPerMonth;
            });
            
            // Check 1: Total capacity
            if (totalAvailableSlots < totalDutiesRequired) {
                errors.push(`âš ï¸ Yetersiz Kapasite: ${totalDutiesRequired} gÃ¼n nÃ¶bet var, ancak personel toplamda sadece ${totalAvailableSlots} nÃ¶bet tutabilir. En az ${totalDutiesRequired - totalAvailableSlots} nÃ¶bet daha gerekli.`);
            }
            
            // Check 2: Minimum personnel count for weekly distribution (if enabled)
            if (rulesConfig.maxDutiesPerWeek.enabled) {
                const weeksInMonth = Math.ceil(daysInMonth / 7);
                const maxDutiesPerWeek = rulesConfig.maxDutiesPerWeek.value;
                const minPersonnelNeeded = Math.ceil(daysInMonth / (weeksInMonth * maxDutiesPerWeek));
                
                if (personnel.length < minPersonnelNeeded) {
                    errors.push(`âš ï¸ Yetersiz Personel: HaftalÄ±k ${maxDutiesPerWeek} nÃ¶bet kuralÄ± iÃ§in en az ${minPersonnelNeeded} personel gerekli, ${personnel.length} personel var.`);
                }
            }
            
            // Check 3: Individual duty limits vs month length (if min gap enabled)
            if (rulesConfig.minDaysGap.enabled) {
                personnel.forEach(person => {
                    if (person.maxDutiesPerMonth > 0) {
                        const minGap = rulesConfig.minDaysGap.value;
                        const maxPossibleDuties = Math.floor(daysInMonth / (minGap + 1)) + 1;
                        
                        if (person.maxDutiesPerMonth > maxPossibleDuties) {
                            errors.push(`âš ï¸ ${person.name}: ${person.maxDutiesPerMonth} nÃ¶bet Ã§ok fazla. Bu ay iÃ§in ${minGap} gÃ¼nlÃ¼k ara kuralÄ±yla maksimum ~${maxPossibleDuties} nÃ¶bet mÃ¼mkÃ¼n.`);
                        }
                    }
                });
            }
            
            // Check 4: Fixed dates conflicts
            const fixedDatesMap = {};
            personnel.forEach(person => {
                person.fixedDates.forEach(date => {
                    if (date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
                        if (fixedDatesMap[date]) {
                            errors.push(`âš ï¸ Tarih Ã‡akÄ±ÅŸmasÄ±: ${formatDate(date)} tarihinde birden fazla kiÅŸi sabit nÃ¶bet olarak atanmÄ±ÅŸ (${fixedDatesMap[date]}, ${person.name}).`);
                        } else {
                            fixedDatesMap[date] = person.name;
                        }
                    }
                });
            });
            
            // Check 5: Weekend/weekday balance feasibility (if enabled and strict)
            if (rulesConfig.weekendBalance.enabled && rulesConfig.weekendBalance.mode === 'strict') {
                let weekendDays = 0;
                let weekdayDays = 0;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month - 1, day);
                    const dayOfWeek = date.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        weekendDays++;
                    } else {
                        weekdayDays++;
                    }
                }
                
                // Each person can take max weekdayDays duties (to maintain balance)
                const totalWeekendCapacity = personnel.reduce((sum, p) => {
                    return sum + Math.floor(p.maxDutiesPerMonth / 2);
                }, 0);
                
                if (totalWeekendCapacity < weekendDays) {
                    errors.push(`âš ï¸ Hafta Sonu Dengesi: ${weekendDays} hafta sonu gÃ¼nÃ¼ var, ancak personel sÄ±kÄ± hafta sonu/iÃ§i dengesi ile maksimum ${totalWeekendCapacity} hafta sonu nÃ¶beti tutabilir. Denge modunu 'Tercih' veya 'Yok' yapÄ±n ya da personel limitleri yÃ¼kseltin.`);
                }
            }
            
            // Check 6: At least some personnel with reasonable duty counts
            const reasonablePersonnel = personnel.filter(p => p.maxDutiesPerMonth >= 2);
            if (reasonablePersonnel.length < 3 && daysInMonth > 10) {
                errors.push(`âš ï¸ Az NÃ¶bet SÄ±nÄ±rÄ±: Ã‡oÄŸu personelin nÃ¶bet sÄ±nÄ±rÄ± Ã§ok dÃ¼ÅŸÃ¼k. Dengeli daÄŸÄ±lÄ±m iÃ§in daha fazla personele daha yÃ¼ksek limitler verin.`);
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // Create schedule algorithm
        function createSchedule(monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const newSchedule = [];

            // Convert exception days to full dates for the selected month
            personnel.forEach(person => {
                // Initialize arrays if not present
                if (!person.exceptionDays) person.exceptionDays = [];
                if (!person.exceptionDates) person.exceptionDates = [];
                if (!person.fixedDates) person.fixedDates = [];
                
                // Convert exception days to full dates
                const fullExceptionDates = [];
                if (person.exceptionDays && person.exceptionDays.length > 0) {
                    person.exceptionDays.forEach(day => {
                        if (day >= 1 && day <= daysInMonth) {
                            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            fullExceptionDates.push(dateStr);
                        }
                    });
                }
                
                // Merge with existing exception dates (from manual entry in edit modal)
                person.exceptionDates = [...new Set([...fullExceptionDates, ...(person.exceptionDates || [])])];
            });

            // Initialize schedule with fixed dates
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dateStr = formatDateISO(date);
                
                let assignedPerson = null;
                
                // Check for fixed dates
                for (const person of personnel) {
                    if (person.fixedDates && person.fixedDates.includes(dateStr)) {
                        assignedPerson = person.name;
                        break;
                    }
                }
                
                newSchedule.push({
                    date: dateStr,
                    dayOfWeek: date.getDay(),
                    dayName: getDayName(date.getDay()),
                    assignedTo: assignedPerson,
                    isWeekend: date.getDay() === 0 || date.getDay() === 6,
                    isLocked: assignedPerson !== null
                });
            }

            // Assign remaining duties
            const unassignedDays = newSchedule.filter(day => !day.assignedTo);
            
            // Create duty tracking for each person
            const dutyTracking = personnel.map(person => ({
                name: person.name,
                weekdayDuties: 0,
                weekendDuties: 0,
                totalDuties: 0,
                lastDutyDate: null,
                maxDuties: person.maxDutiesPerMonth,
                exceptionDates: person.exceptionDates || [],
                fixedDates: person.fixedDates || []
            }));

            // Count fixed duties
            newSchedule.forEach(day => {
                if (day.assignedTo) {
                    const personTrack = dutyTracking.find(p => p.name === day.assignedTo);
                    if (personTrack) {
                        personTrack.totalDuties++;
                        if (day.isWeekend) {
                            personTrack.weekendDuties++;
                        } else {
                            personTrack.weekdayDuties++;
                        }
                        personTrack.lastDutyDate = day.date;
                    }
                }
            });

            // Assign unassigned days
            for (const day of unassignedDays) {
                const eligiblePersonnel = dutyTracking.filter(person => {
                    // Check exception dates
                    if (person.exceptionDates.includes(day.date)) return false;
                    
                    // Check max duties
                    if (person.totalDuties >= person.maxDuties) return false;
                    
                    // Check weekly limit (if enabled)
                    if (rulesConfig.maxDutiesPerWeek.enabled) {
                        const weekStart = getWeekStart(day.date);
                        const weekEnd = getWeekEnd(day.date);
                        const dutiesThisWeek = newSchedule.filter(d => 
                            d.assignedTo === person.name && 
                            d.date >= weekStart && 
                            d.date <= weekEnd
                        ).length;
                        if (dutiesThisWeek >= rulesConfig.maxDutiesPerWeek.value) return false;
                    }
                    
                    // Check minimum gap (if enabled)
                    if (rulesConfig.minDaysGap.enabled && person.lastDutyDate) {
                        const daysBetween = daysBetweenDates(person.lastDutyDate, day.date);
                        if (daysBetween < rulesConfig.minDaysGap.value) return false;
                    }
                    
                    // Check consecutive days (if enabled)
                    if (rulesConfig.noConsecutive.enabled && person.lastDutyDate) {
                        const daysBetween = daysBetweenDates(person.lastDutyDate, day.date);
                        if (daysBetween === 1) return false;
                    }
                    
                    // Check weekend/weekday balance (if enabled and strict)
                    if (rulesConfig.weekendBalance.enabled && rulesConfig.weekendBalance.mode === 'strict') {
                        if (day.isWeekend) {
                            if (person.weekendDuties >= person.weekdayDuties) return false;
                        }
                    }
                    
                    return true;
                });

                if (eligiblePersonnel.length === 0) {
                    throw new Error(`${day.date} tarihine uygun personel bulunamadÄ±. KurallarÄ± gevÅŸetmeyi veya personel sayÄ±sÄ±nÄ± artÄ±rmayÄ± deneyin.`);
                }

                // Select person based on distribution mode
                let selectedPerson;
                
                if (!rulesConfig.fairDistribution.enabled || rulesConfig.fairDistribution.mode === 'random') {
                    // Random selection
                    selectedPerson = eligiblePersonnel[Math.floor(Math.random() * eligiblePersonnel.length)];
                } else if (rulesConfig.fairDistribution.mode === 'priority') {
                    // Priority: least duties first
                    eligiblePersonnel.sort((a, b) => a.totalDuties - b.totalDuties);
                    selectedPerson = eligiblePersonnel[0];
                } else {
                    // Balanced: consider weekend balance too
                    eligiblePersonnel.sort((a, b) => {
                        if (rulesConfig.weekendBalance.enabled && (rulesConfig.weekendBalance.mode === 'strict' || rulesConfig.weekendBalance.mode === 'prefer')) {
                            if (day.isWeekend) {
                                const aBalance = a.weekdayDuties - a.weekendDuties;
                                const bBalance = b.weekdayDuties - b.weekendDuties;
                                if (aBalance !== bBalance) return bBalance - aBalance;
                            }
                        }
                        return a.totalDuties - b.totalDuties;
                    });
                    selectedPerson = eligiblePersonnel[0];
                }

                day.assignedTo = selectedPerson.name;
                
                // Update tracking
                selectedPerson.totalDuties++;
                if (day.isWeekend) {
                    selectedPerson.weekendDuties++;
                } else {
                    selectedPerson.weekdayDuties++;
                }
                selectedPerson.lastDutyDate = day.date;
            }

            return newSchedule;
        }

        // Display schedule stats
        function displayScheduleStats() {
            const container = document.getElementById('schedule-stats');
            const stats = calculateStats();

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${schedule.length}</div>
                    <div class="stat-label">Toplam GÃ¼n</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalWeekends}</div>
                    <div class="stat-label">Hafta Sonu</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalWeekdays}</div>
                    <div class="stat-label">Hafta Ä°Ã§i</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${personnel.length}</div>
                    <div class="stat-label">Aktif Personel</div>
                </div>
            `;
        }

        // Calculate statistics
        function calculateStats() {
            const totalWeekends = schedule.filter(d => d.isWeekend).length;
            const totalWeekdays = schedule.filter(d => !d.isWeekend).length;

            return { totalWeekends, totalWeekdays };
        }

        // Display schedule table
        function displayScheduleTable() {
            const container = document.getElementById('schedule-table-container');
            
            if (schedule.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">HenÃ¼z Ã§izelge oluÅŸturulmadÄ±.</p>';
                return;
            }

            // Create matrix view: rows = personnel, columns = dates
            const matrix = {};
            
            // Initialize matrix for each person
            personnel.forEach(person => {
                matrix[person.name] = {};
            });
            
            // Fill matrix with duties
            schedule.forEach(day => {
                if (day.assignedTo && matrix[day.assignedTo]) {
                    matrix[day.assignedTo][day.date] = {
                        isWeekend: day.isWeekend,
                        isLocked: day.isLocked
                    };
                }
            });

            // Build table HTML
            let tableHTML = '<div style="overflow-x: auto;"><table style="min-width: 100%;">';
            
            // Header row with dates
            tableHTML += '<thead><tr>';
            tableHTML += '<th style="position: sticky; left: 0; z-index: 10; background: var(--army-green);">Personel</th>';
            
            schedule.forEach(day => {
                const date = new Date(day.date);
                const dayNum = date.getDate();
                const isWeekend = day.isWeekend;
                
                tableHTML += `<th style="text-align: center; min-width: 45px; ${isWeekend ? 'background: #5d6e4e;' : ''}" title="${formatDate(day.date)} - ${day.dayName}">
                    <div style="font-size: 0.75rem;">${day.dayName.substring(0, 3)}</div>
                    <div style="font-size: 1.1rem; font-weight: bold;">${dayNum}</div>
                </th>`;
            });
            
            tableHTML += '</tr></thead><tbody>';
            
            // Data rows - one per person
            personnel.forEach(person => {
                tableHTML += '<tr>';
                tableHTML += `<td style="position: sticky; left: 0; z-index: 5; background: var(--light-bg); font-weight: bold; white-space: nowrap;">
                    ${person.name}
                </td>`;
                
                schedule.forEach(day => {
                    const hasDuty = matrix[person.name][day.date];
                    const isWeekend = day.isWeekend;
                    
                    if (hasDuty) {
                        const icon = hasDuty.isLocked ? 'ğŸ”’' : 'âœ“';
                        const bgColor = hasDuty.isLocked ? '#d1ecf1' : (isWeekend ? '#fff3cd' : '#d4edda');
                        tableHTML += `<td style="text-align: center; background: ${bgColor}; font-size: 1.3rem; font-weight: bold;">
                            ${icon}
                        </td>`;
                    } else {
                        const bgColor = isWeekend ? '#f8f8f8' : 'white';
                        tableHTML += `<td style="text-align: center; background: ${bgColor}; color: #ddd;">-</td>`;
                    }
                });
                
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table></div>';
            
            // Add legend
            tableHTML += `
                <div style="margin-top: 20px; padding: 15px; background: var(--light-bg); border-radius: 6px; display: flex; gap: 20px; flex-wrap: wrap;">
                    <div><span style="display: inline-block; width: 20px; height: 20px; background: #d4edda; border: 1px solid #999; vertical-align: middle;"></span> Hafta Ä°Ã§i NÃ¶bet</div>
                    <div><span style="display: inline-block; width: 20px; height: 20px; background: #fff3cd; border: 1px solid #999; vertical-align: middle;"></span> Hafta Sonu NÃ¶bet</div>
                    <div><span style="display: inline-block; width: 20px; height: 20px; background: #d1ecf1; border: 1px solid #999; vertical-align: middle;"></span> Sabit NÃ¶bet (ğŸ”’)</div>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        // Update swap selects
        function updateSwapSelects() {
            const select1 = document.getElementById('swap-date-1');
            const select2 = document.getElementById('swap-date-2');

            if (schedule.length === 0) {
                select1.innerHTML = '<option value="">GÃ¼n SeÃ§in</option>';
                select2.innerHTML = '<option value="">GÃ¼n SeÃ§in</option>';
                return;
            }

            const options = schedule
                .filter(day => !day.isLocked)
                .map(day => `
                    <option value="${day.date}">
                        ${formatDate(day.date)} - ${day.dayName} - ${day.assignedTo}
                    </option>
                `).join('');

            select1.innerHTML = '<option value="">GÃ¼n SeÃ§in</option>' + options;
            select2.innerHTML = '<option value="">GÃ¼n SeÃ§in</option>' + options;
        }

        // Perform swap
        function performSwap() {
            const messageContainer = document.getElementById('swap-message');
            messageContainer.innerHTML = '';

            const date1 = document.getElementById('swap-date-1').value;
            const date2 = document.getElementById('swap-date-2').value;

            if (!date1 || !date2) {
                messageContainer.innerHTML = '<div class="error-message">âŒ LÃ¼tfen iki nÃ¶bet gÃ¼nÃ¼ seÃ§in.</div>';
                return;
            }

            if (date1 === date2) {
                messageContainer.innerHTML = '<div class="error-message">âŒ AynÄ± gÃ¼nÃ¼ iki kez seÃ§emezsiniz.</div>';
                return;
            }

            const day1 = schedule.find(d => d.date === date1);
            const day2 = schedule.find(d => d.date === date2);

            if (day1.isLocked || day2.isLocked) {
                messageContainer.innerHTML = '<div class="error-message">âŒ Sabit nÃ¶betler deÄŸiÅŸtirilemez.</div>';
                return;
            }

            // Swap
            const temp = day1.assignedTo;
            day1.assignedTo = day2.assignedTo;
            day2.assignedTo = temp;

            messageContainer.innerHTML = '<div class="success-message">âœ… NÃ¶bet deÄŸiÅŸimi baÅŸarÄ±yla yapÄ±ldÄ±!</div>';
            displayScheduleTable();
            updateSwapPreview();
            updateSwapSelects();
        }

        // Update swap preview
        function updateSwapPreview() {
            const container = document.getElementById('swap-preview');
            
            if (schedule.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">HenÃ¼z Ã§izelge oluÅŸturulmadÄ±.</p>';
                return;
            }

            // Show first 10 days in matrix format
            const previewSchedule = schedule.slice(0, 10);
            
            // Create matrix
            const matrix = {};
            personnel.forEach(person => {
                matrix[person.name] = {};
            });
            
            previewSchedule.forEach(day => {
                if (day.assignedTo && matrix[day.assignedTo]) {
                    matrix[day.assignedTo][day.date] = {
                        isWeekend: day.isWeekend,
                        isLocked: day.isLocked
                    };
                }
            });

            let tableHTML = '<div style="overflow-x: auto;"><table style="font-size: 0.9rem;">';
            
            // Header
            tableHTML += '<thead><tr>';
            tableHTML += '<th style="position: sticky; left: 0; z-index: 10; background: var(--army-green);">Personel</th>';
            
            previewSchedule.forEach(day => {
                const date = new Date(day.date);
                const dayNum = date.getDate();
                const isWeekend = day.isWeekend;
                
                tableHTML += `<th style="text-align: center; min-width: 40px; ${isWeekend ? 'background: #5d6e4e;' : ''}">
                    <div style="font-size: 0.7rem;">${day.dayName.substring(0, 2)}</div>
                    <div style="font-size: 0.95rem; font-weight: bold;">${dayNum}</div>
                </th>`;
            });
            
            tableHTML += '</tr></thead><tbody>';
            
            // Rows
            personnel.forEach(person => {
                tableHTML += '<tr>';
                tableHTML += `<td style="position: sticky; left: 0; z-index: 5; background: var(--light-bg); font-weight: bold; text-align: left; font-size: 0.85rem;">
                    ${person.name}
                </td>`;
                
                previewSchedule.forEach(day => {
                    const hasDuty = matrix[person.name][day.date];
                    const isWeekend = day.isWeekend;
                    
                    if (hasDuty) {
                        const icon = hasDuty.isLocked ? 'ğŸ”’' : 'âœ“';
                        const bgColor = hasDuty.isLocked ? '#d1ecf1' : (isWeekend ? '#fff3cd' : '#d4edda');
                        tableHTML += `<td style="text-align: center; background: ${bgColor}; font-size: 1.1rem;">
                            ${icon}
                        </td>`;
                    } else {
                        const bgColor = isWeekend ? '#f8f8f8' : 'white';
                        tableHTML += `<td style="text-align: center; background: ${bgColor}; color: #ddd; font-size: 0.8rem;">-</td>`;
                    }
                });
                
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table></div>';
            
            if (schedule.length > 10) {
                tableHTML += '<p style="text-align: center; color: #999; margin-top: 10px; font-size: 0.85rem;">Ä°lk 10 gÃ¼n gÃ¶steriliyor. Tam Ã§izelge iÃ§in "NÃ¶bet Ã‡izelgesi" sekmesine bakÄ±n.</p>';
            }

            container.innerHTML = tableHTML;
        }

        // Export to CSV
        function exportToCSV() {
            if (schedule.length === 0) {
                alert('HenÃ¼z Ã§izelge oluÅŸturulmadÄ±.');
                return;
            }

            // Ask user which format they want
            const format = confirm('RenklendirilmiÅŸ HTML formatÄ±nda mÄ± dÄ±ÅŸa aktarmak istersiniz?\n\nEvet = HTML Matris (Renkli, Excel\'de aÃ§Ä±labilir)\nHayÄ±r = CSV Liste (DÃ¼z metin)');

            if (format) {
                // HTML Matrix format with colors
                exportToHTMLMatrix();
            } else {
                // Plain CSV list format
                exportToPlainCSV();
            }
        }

        function exportToHTMLMatrix() {
            // Create matrix
            const matrix = {};
            personnel.forEach(person => {
                matrix[person.name] = {};
            });
            
            schedule.forEach(day => {
                if (day.assignedTo && matrix[day.assignedTo]) {
                    matrix[day.assignedTo][day.date] = {
                        isWeekend: day.isWeekend,
                        isLocked: day.isLocked
                    };
                }
            });

            // Build HTML
            let html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>NÃ¶bet Ã‡izelgesi</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #4a5d3e; text-align: center; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #666; padding: 8px; text-align: center; font-size: 11px; }
        th { background-color: #4a5d3e; color: #d4c5a9; font-weight: bold; }
        th.weekend { background-color: #5d6e4e; }
        td.personnel { background-color: #f4f0e6; font-weight: bold; text-align: left; white-space: nowrap; }
        td.weekday-duty { background-color: #d4edda; font-weight: bold; }
        td.weekend-duty { background-color: #fff3cd; font-weight: bold; }
        td.locked-duty { background-color: #d1ecf1; font-weight: bold; }
        td.no-duty { background-color: #ffffff; color: #ddd; }
        .legend { margin-top: 20px; display: flex; gap: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-box { width: 20px; height: 20px; border: 1px solid #999; }
    </style>
</head>
<body>
    <h1>ğŸ–ï¸ NÃ¶bet Ã‡izelgesi</h1>
    <p style="text-align: center; color: #666;">OluÅŸturulma: ${new Date().toLocaleString('tr-TR')}</p>
    
    <table>
        <thead>
            <tr>
                <th>Personel</th>`;

            // Header with dates
            schedule.forEach(day => {
                const date = new Date(day.date);
                const dayNum = date.getDate();
                const isWeekend = day.isWeekend;
                
                html += `<th class="${isWeekend ? 'weekend' : ''}">
                    <div>${day.dayName.substring(0, 3)}</div>
                    <div style="font-size: 13px; font-weight: bold;">${dayNum}</div>
                </th>`;
            });

            html += `</tr></thead><tbody>`;

            // Data rows
            personnel.forEach(person => {
                html += `<tr><td class="personnel">${person.name}</td>`;
                
                schedule.forEach(day => {
                    const hasDuty = matrix[person.name][day.date];
                    
                    if (hasDuty) {
                        const icon = hasDuty.isLocked ? 'ğŸ”’' : 'âœ“';
                        const className = hasDuty.isLocked ? 'locked-duty' : 
                                        (hasDuty.isWeekend ? 'weekend-duty' : 'weekday-duty');
                        html += `<td class="${className}">${icon}</td>`;
                    } else {
                        html += `<td class="no-duty">-</td>`;
                    }
                });
                
                html += `</tr>`;
            });

            html += `</tbody></table>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-box" style="background-color: #d4edda;"></div>
            <span>Hafta Ä°Ã§i NÃ¶bet</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background-color: #fff3cd;"></div>
            <span>Hafta Sonu NÃ¶bet</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background-color: #d1ecf1;"></div>
            <span>Sabit NÃ¶bet (ğŸ”’)</span>
        </div>
    </div>
</body>
</html>`;

            // Save as HTML file
            const blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `nobet_cizelgesi_${new Date().getTime()}.html`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToPlainCSV() {
            // Plain CSV list format
            let csv = 'Tarih,GÃ¼n,GÃ¶revli Personel\n';
            schedule.forEach(day => {
                csv += `${formatDate(day.date)},${day.dayName},${day.assignedTo}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `nobet_cizelgesi_liste_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Export to Excel
        function exportToExcel() {
            if (schedule.length === 0) {
                alert('HenÃ¼z Ã§izelge oluÅŸturulmadÄ±.');
                return;
            }

            // Create matrix
            const matrix = {};
            personnel.forEach(person => {
                matrix[person.name] = {};
            });
            
            schedule.forEach(day => {
                if (day.assignedTo && matrix[day.assignedTo]) {
                    matrix[day.assignedTo][day.date] = {
                        isWeekend: day.isWeekend,
                        isLocked: day.isLocked
                    };
                }
            });

            // Build HTML table for Excel with proper styling
            let html = `
<html xmlns:o="urn:schemas-microsoft-com:office:office" 
      xmlns:x="urn:schemas-microsoft-com:office:excel" 
      xmlns="http://www.w3.org/TR/REC-html40">
<head>
    <meta charset="UTF-8">
    <xml>
        <x:ExcelWorkbook>
            <x:ExcelWorksheets>
                <x:ExcelWorksheet>
                    <x:Name>NÃ¶bet Ã‡izelgesi</x:Name>
                    <x:WorksheetOptions>
                        <x:Print>
                            <x:ValidPrinterInfo/>
                        </x:Print>
                    </x:WorksheetOptions>
                </x:ExcelWorksheet>
            </x:ExcelWorksheets>
        </x:ExcelWorkbook>
    </xml>
    <style>
        table {
            border-collapse: collapse;
            font-family: Calibri, Arial, sans-serif;
            font-size: 11pt;
        }
        th, td {
            border: 1px solid #000000;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: #4a5d3e;
            color: white;
            font-weight: bold;
            font-size: 10pt;
        }
        th.weekend {
            background-color: #d4c5a9;
            color: #000000;
        }
        td.personnel {
            background-color: #f4f0e6;
            font-weight: bold;
            text-align: left;
            white-space: nowrap;
        }
        td.weekday-duty {
            background-color: #d4edda;
            font-weight: bold;
            font-size: 16pt;
        }
        td.weekend-duty {
            background-color: #fff3cd;
            font-weight: bold;
            font-size: 16pt;
        }
        td.locked-duty {
            background-color: #d1ecf1;
            font-weight: bold;
            font-size: 16pt;
        }
        td.no-duty {
            background-color: #ffffff;
        }
    </style>
</head>
<body>
    <table>
        <thead>
            <tr>
                <th>PERSONEL</th>`;

            // Header with dates
            schedule.forEach(day => {
                const date = new Date(day.date);
                const dayNum = date.getDate();
                const isWeekend = day.isWeekend;
                const dayAbbr = day.dayName.substring(0, 3).toUpperCase();
                
                html += `<th class="${isWeekend ? 'weekend' : ''}">${dayAbbr}<br>${dayNum}</th>`;
            });

            html += `</tr></thead><tbody>`;

            // Data rows
            personnel.forEach(person => {
                html += `<tr><td class="personnel">${person.name}</td>`;
                
                schedule.forEach(day => {
                    const hasDuty = matrix[person.name][day.date];
                    
                    if (hasDuty) {
                        const icon = 'âœ“';
                        const className = hasDuty.isLocked ? 'locked-duty' : 
                                        (hasDuty.isWeekend ? 'weekend-duty' : 'weekday-duty');
                        html += `<td class="${className}">${icon}</td>`;
                    } else {
                        html += `<td class="no-duty"></td>`;
                    }
                });
                
                html += `</tr>`;
            });

            html += `</tbody></table></body></html>`;

            // Save as Excel file
            const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `nobet_cizelgesi_${new Date().getTime()}.xls`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Export to PDF
        function exportToPDF() {
            if (schedule.length === 0) {
                alert('HenÃ¼z Ã§izelge oluÅŸturulmadÄ±.');
                return;
            }

            // Create a printable version
            const printWindow = window.open('', '_blank');
            
            // Create matrix
            const matrix = {};
            personnel.forEach(person => {
                matrix[person.name] = {};
            });
            
            schedule.forEach(day => {
                if (day.assignedTo && matrix[day.assignedTo]) {
                    matrix[day.assignedTo][day.date] = {
                        isWeekend: day.isWeekend,
                        isLocked: day.isLocked
                    };
                }
            });

            let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>NÃ¶bet Ã‡izelgesi</title>
    <style>
        @page {
            size: A4 landscape;
            margin: 15mm;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
        }
        h1 {
            text-align: center;
            color: #4a5d3e;
            font-size: 18pt;
            margin-bottom: 10px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 9pt;
        }
        th, td {
            border: 1px solid #000000;
            padding: 6px 4px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: #4a5d3e;
            color: white;
            font-weight: bold;
            font-size: 8pt;
        }
        th.weekend {
            background-color: #d4c5a9;
            color: #000000;
        }
        td.personnel {
            background-color: #f4f0e6;
            font-weight: bold;
            text-align: left;
            white-space: nowrap;
            font-size: 9pt;
        }
        td.weekday-duty {
            background-color: #d4edda;
            font-weight: bold;
            font-size: 14pt;
        }
        td.weekend-duty {
            background-color: #fff3cd;
            font-weight: bold;
            font-size: 14pt;
        }
        td.locked-duty {
            background-color: #d1ecf1;
            font-weight: bold;
            font-size: 14pt;
        }
        td.no-duty {
            background-color: #ffffff;
        }
        .footer {
            margin-top: 10px;
            font-size: 8pt;
            text-align: center;
            color: #666;
        }
        @media print {
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <h1>NÃ¶bet Ã‡izelgesi</h1>
    <button class="no-print" onclick="window.print()" style="margin-bottom: 10px; padding: 8px 16px; background: #4a5d3e; color: white; border: none; cursor: pointer; border-radius: 4px;">ğŸ“„ PDF Olarak Kaydet</button>
    
    <table>
        <thead>
            <tr>
                <th>PERSONEL</th>`;

            // Header with dates
            schedule.forEach(day => {
                const date = new Date(day.date);
                const dayNum = date.getDate();
                const isWeekend = day.isWeekend;
                const dayAbbr = day.dayName.substring(0, 3).toUpperCase();
                
                html += `<th class="${isWeekend ? 'weekend' : ''}">${dayAbbr}<br>${dayNum}</th>`;
            });

            html += `</tr></thead><tbody>`;

            // Data rows
            personnel.forEach(person => {
                html += `<tr><td class="personnel">${person.name}</td>`;
                
                schedule.forEach(day => {
                    const hasDuty = matrix[person.name][day.date];
                    
                    if (hasDuty) {
                        const icon = 'âœ“';
                        const className = hasDuty.isLocked ? 'locked-duty' : 
                                        (hasDuty.isWeekend ? 'weekend-duty' : 'weekday-duty');
                        html += `<td class="${className}">${icon}</td>`;
                    } else {
                        html += `<td class="no-duty"></td>`;
                    }
                });
                
                html += `</tr>`;
            });

            html += `</tbody></table>
    <div class="footer">OluÅŸturulma Tarihi: ${new Date().toLocaleString('tr-TR')}</div>
</body>
</html>`;

            printWindow.document.write(html);
            printWindow.document.close();
        }

        // Print schedule
        function printSchedule() {
            if (schedule.length === 0) {
                alert('HenÃ¼z Ã§izelge oluÅŸturulmadÄ±.');
                return;
            }
            window.print();
        }

        // Utility functions
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('tr-TR');
        }

        function formatDateISO(date) {
            // Local timezone kullanarak tarih formatla (UTC timezone sorununu Ã¶nler)
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDayName(dayOfWeek) {
            const days = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];
            return days[dayOfWeek];
        }

        function getWeekStart(dateStr) {
            const date = new Date(dateStr);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Monday
            return formatDateISO(new Date(date.setDate(diff)));
        }

        function getWeekEnd(dateStr) {
            const date = new Date(dateStr);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? 0 : 7); // Sunday
            return formatDateISO(new Date(date.setDate(diff)));
        }

        function daysBetweenDates(date1Str, date2Str) {
            const date1 = new Date(date1Str);
            const date2 = new Date(date2Str);
            const diffTime = Math.abs(date2 - date1);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
    </script>
</body>
</html>
